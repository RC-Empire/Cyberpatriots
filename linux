set -euo pipefail
LOG="$HOME/Desktop/Script.log"
BACKUP_DIR="/root/cp_backups/$(date +%F_%H%M%S)"
MEDIA_REPORT="$HOME/Desktop/media_files.txt"
WORLD_WRITABLE="$HOME/Desktop/world_writable.txt"
REPORT_DIR="$HOME/Desktop/cp_reports_$(date +%F_%H%M%S)"
mkdir -p "$BACKUP_DIR" "$REPORT_DIR"
mkdir -p "$(dirname "$LOG")"
: > "$LOG"
log() { echo "$(date -Iseconds) $*" | tee -a "$LOG"; }
if [[ $(id -u) -ne 0 ]]; then
  echo "This script must be run as root (sudo)." >&2
  exit 2
fi
log "=== CyberPatriot auto-harden started ==="
log "Backup directory: $BACKUP_DIR"
log "Reports directory: $REPORT_DIR"
log "Updating package lists and upgrading packages (non-interactive)..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y >>"$LOG" 2>&1
apt-get upgrade -y >>"$LOG" 2>&1
log "Package update/upgrade complete."
log "Ensuring required security packages are installed: ufw, fail2ban, auditd, libpam-pwquality"
apt-get install -y ufw fail2ban auditd libpam-pwquality tree >/dev/null 2>>"$LOG" || true
log "Security packages installed or already present."
backup() {
  local f="$1"
  if [[ -f "$f" ]]; then
    mkdir -p "$BACKUP_DIR$(dirname "$f")"
    cp -a "$f" "$BACKUP_DIR$f"
    log "Backed up $f -> $BACKUP_DIR$f"
  fi
}
backup /etc/passwd
backup /etc/group
backup /etc/shadow
backup /etc/sudoers
backup /etc/ssh/sshd_config
backup /etc/login.defs
backup /etc/pam.d/common-password
backup /etc/apt/apt.conf.d/10periodic
backup /etc/sysctl.conf
log "Configuring UFW: reset, default deny incoming, allow outgoing."
ufw --force reset >>"$LOG" 2>&1
ufw default deny incoming >>"$LOG" 2>&1
ufw default allow outgoing >>"$LOG" 2>&1
ufw allow 22/tcp  # SSH
ufw allow 80/tcp  # HTTP (allowed in case web service legitimately required)
ufw allow 443/tcp # HTTPS
ufw --force enable >>"$LOG" 2>&1
log "UFW enabled and rules applied. Current status:"
ufw status verbose | tee -a "$LOG"
if [[ -f "$SSHD" ]]; then
    sed -i.bak -E 's/^\s*#?\s*Protocol\s+.*/Protocol 2/' "$SSHD" || true
  sed -i -E 's/^\s*#?\s*PermitRootLogin\s+.*/PermitRootLogin no/' "$SSHD" || echo "PermitRootLogin no" >> "$SSHD"
  sed -i -E 's/^\s*#?\s*X11Forwarding\s+.*/X11Forwarding no/' "$SSHD" || true
  sed -i -E 's/^\s*#?\s*UsePAM\s+.*/UsePAM yes/' "$SSHD" || true
  sed -i -E 's/^\s*#?\s*AllowTcpForwarding\s+.*/AllowTcpForwarding no/' "$SSHD" || true
  sed -i -E 's/^\s*#?\s*AllowUsers\s+.*/#AllowUsers (managed by script)/' "$SSHD" || true
  AUTHKEYS_FOUND=$(find /home /root -maxdepth 3 -type f -name authorized_keys 2>/dev/null | wc -l || true)
  if [[ "$AUTHKEYS_FOUND" -gt 0 ]]; then
   sed -i.bak -E 's/^\s*#?\s*PasswordAuthentication\s+.*/PasswordAuthentication no/' "$SSHD" || echo "PasswordAuthentication no" >> "$SSHD"
    log "PasswordAuthentication disabled because authorized_keys found on system ($AUTHKEYS_FOUND files)."
  else
    sed -i.bak -E 's/^\s*#?\s*PasswordAuthentication\s+.*/PasswordAuthentication yes/' "$SSHD" || true
    log "WARNING: No authorized_keys found on system; PasswordAuthentication left ENABLED to avoid lockout. Add SSH keys and re-run script to disable password auth."
  Fi
 if sshd -t >>"$LOG" 2>&1; then
    systemctl reload sshd
    log "sshd config test OK and sshd reloaded."
  else
    log "ERROR: sshd -t failed. Restoring previous sshd_config and aborting ssh reload."
    cp "$BACKUP_DIR/etc/ssh/sshd_config" "$SSHD"
    systemctl reload sshd || true
  fi
else
  log "sshd_config not found; skipping SSH hardening."
fi
log "Applying conservative password policy (login.defs and PAM)."

sed -i.bak -E 's/^\s*PASS_MAX_DAYS\s+.*/PASS_MAX_DAYS   90/' /etc/login.defs || echo "PASS_MAX_DAYS   90" >> /etc/login.defs
sed -i.bak -E 's/^\s*PASS_MIN_DAYS\s+.*/PASS_MIN_DAYS   7/' /etc/login.defs || echo "PASS_MIN_DAYS   7" >> /etc/login.defs
sed -i.bak -E 's/^\s*PASS_WARN_AGE\s+.*/PASS_WARN_AGE   14/' /etc/login.defs || echo "PASS_WARN_AGE   14" >> /etc/login.defs


PWQ_CONF="/etc/security/pwquality.conf"
if ! grep -q "^minlen" "$PWQ_CONF" 2>/dev/null; then
  echo -e "minlen = 10\ndcredit = -1\nucredit = -1\nlcredit = -1\nocredit = -1\ndifok = 3" >> "$PWQ_CONF"
  log "Created/updated $PWQ_CONF with recommended values."
else
   sed -i -E 's/^\s*minlen\s*=\s*[0-9]+/minlen = 10/' "$PWQ_CONF" || true
  log "Ensured minlen=10 in $PWQ_CONF"
fi


if ! grep -q "pam_pwquality.so" /etc/pam.d/common-password; then
  sed -i.bak -E '/pam_unix.so/ s/$/ retry=3/' /etc/pam.d/common-password || true
  sed -i -E '1 i\password requisite pam_pwquality.so retry=3' /etc/pam.d/common-password || true
  log "Added pam_pwquality to /etc/pam.d/common-password"
fi


SYSCTL_FILE="/etc/sysctl.d/99-cp-hardening.conf"
log "Applying network sysctl hardening (writing $SYSCTL_FILE)."
cat > "$SYSCTL_FILE" <<'EOF'

net.ipv4.ip_forward = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.log_martians = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

EOF
sysctl --system >>"$LOG" 2>&1
log "sysctl settings applied."

# -------------------------

# -------------------------
log "Setting safe permissions for /etc/shadow and user bash history files."
chmod 640 /etc/shadow || true
chown root:shadow /etc/shadow || true
log "/etc/shadow permissions ensured (640) and owner root:shadow."


while IFS=: read -r user _ uid _ _ home shell; do
  if [[ -d "$home" && "$uid" -ge 1000 && "$shell" != "/usr/sbin/nologin" && "$shell" != "/bin/false" ]]; then
    if [[ -f "$home/.bash_history" ]]; then
      chmod 600 "$home/.bash_history" || true
      chown "$user:$user" "$home/.bash_history" || true
      log "Secured $home/.bash_history"
    fi
  fi
done < /etc/passwd


log "Purging legacy/insecure network services if present: telnet, rsh, talk, tftp, xinetd"
apt-get purge -y telnetd telnet rsh-client rsh-redone-client rsh-server talk tftp xinetd >/dev/null 2>>"$LOG" || true
log "Purge complete (if packages were present)."


log "Enabling and starting auditd and fail2ban."
systemctl enable auditd >/dev/null 2>>"$LOG" || true
systemctl restart auditd >/dev/null 2>>"$LOG" || true
systemctl enable fail2ban >/dev/null 2>>"$LOG" || true
systemctl restart fail2ban >/dev/null 2>>"$LOG" || true
log "auditd and fail2ban enabled/restarted."


if [[ ! -f /etc/fail2ban/jail.d/cp_harden.local ]]; then
  cat > /etc/fail2ban/jail.d/cp_harden.local <<'EOF'
[sshd]
enabled = true
bantime  = 3600
findtime  = 600
maxretry = 5
EOF
  systemctl restart fail2ban || true
  log "Installed basic fail2ban sshd jail."
fi


log "Finding world-writable files (this may take a while)..."
find / -xdev -type f -perm -o+w -print 2>/dev/null > "$WORLD_WRITABLE" || true
log "World-writable file report saved to $WORLD_WRITABLE (first 100 lines):"
head -n 100 "$WORLD_WRITABLE" | tee -a "$LOG"

log "Generating media file list (search under /home only to save time)..."
find /home -type f \( \
  -iname '*.mp3' -o -iname '*.wav' -o -iname '*.flac' -o \
  -iname '*.mp4' -o -iname '*.mkv' -o -iname '*.avi' -o \
  -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o \
  -iname '*.gif' -o -iname '*.bmp' -o -iname '*.mov' \) > "$MEDIA_REPORT" 2>/dev/null || true
log "Media file report saved to $MEDIA_REPORT. Count: $(wc -l < "$MEDIA_REPORT" || echo 0)"


log "Creating snapshot reports for judge review..."
dpkg -l > "$REPORT_DIR/packages.txt"
ss -tulnap > "$REPORT_DIR/listening_sockets.txt"
systemctl list-unit-files --type=service > "$REPORT_DIR/services_unitfiles.txt"
ps aux --sort=-%mem | head -n 200 > "$REPORT_DIR/processes_top.txt"
cp /etc/ssh/sshd_config "$REPORT_DIR/" || true
cp /etc/login.defs "$REPORT_DIR/" || true
cp /etc/pam.d/common-password "$REPORT_DIR/" || true
cp "$WORLD_WRITABLE" "$REPORT_DIR/" || true
cp "$MEDIA_REPORT" "$REPORT_DIR/" || true
log "Reports created in $REPORT_DIR."


log "Performing apt autoremove / autoclean to remove orphaned packages (non-interactive)."
apt-get autoremove -y >>"$LOG" 2>&1 || true
apt-get autoclean -y >>"$LOG" 2>&1 || true

log "Auto-harden complete. Summary:"
log "  Backups: $BACKUP_DIR"
log "  Main log : $LOG"
log "  World-writable report: $WORLD_WRITABLE"
log "  Media report: $MEDIA_REPORT"
log "  Reports directory (detailed): $REPORT_DIR"
log "Recommend: verify SSH access (and authorized_keys) before running on a remote competition VM. Test on a VM first."

echo
echo "Auto-harden finished. See $LOG and reports in $REPORT_DIR and on your Desktop."
exit 0

